<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>텔레그램 봇 스켈레톤 만들기 - hy43 wiki</title>

    <meta name="description" content="node.js, heroku로 만드는 텔레그램 챗봇">

    <link rel="stylesheet" href="/css/main.css">
    <link rel="canonical" href="http://localhost:4000/blog/2017/03/12/telegram-bot/">
    <link rel="alternate" type="application/rss+xml" title="hy43 wiki" href="http://localhost:4000/feed.xml" />

    <meta property="og:type" content="website">
    <meta property="og:title" content="텔레그램 봇 스켈레톤 만들기">
    <meta property="og:description" content="node.js, heroku로 만드는 텔레그램 챗봇">
    <meta property="og:image" content="http://localhost:4000/resource/johngrib.png">
    <meta property="og:url" content="http://localhost:4000/blog/2017/03/12/telegram-bot/">

    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@" />
    <meta name="twitter:url" content="http://localhost:4000/blog/2017/03/12/telegram-bot/" />
    <meta name="twitter:title" content="텔레그램 봇 스켈레톤 만들기" />
    <meta name="twitter:description" content="node.js, heroku로 만드는 텔레그램 챗봇" />

    <link rel="apple-touch-icon" sizes="57x57"        href="/resource/icon/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60"        href="/resource/icon/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72"        href="/resource/icon/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76"        href="/resource/icon/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114"      href="/resource/icon/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120"      href="/resource/icon/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144"      href="/resource/icon/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152"      href="/resource/icon/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180"      href="/resource/icon/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/resource/icon/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32"   href="/resource/icon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96"   href="/resource/icon/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16"   href="/resource/icon/favicon-16x16.png">
    <link rel="manifest" href="/resource/icon/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/resource/icon/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">


    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-110224147-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-110224147-1');
    </script>



</head>
<header class="header">
    <div>
        <a class="site-title" href="/">hy43 wiki</a>
    </div>
    <div>
        <a class="site-title-right" href="/about/">me</a>
    </div>
    <div>
        <a id="random-button" class="site-title-right" href="/wiki/index/#random" onClick="if(typeof random === 'function')random()">random</a>
    </div>
    <div>
        <a class="site-title-right" href="/wiki/index/">wiki</a>
    </div>
</header>
<script>
;(function(){
    var isCtrl = false;

    document.onkeyup=function(e){
        if (e.which == 17) {
            isCtrl = false;
        }
    }

    document.onkeydown=function(e){
        if(e.which == 17) {
            isCtrl = true;
        }
        if(e.which == 82 && isCtrl == true) {
            document.getElementById("random-button").click();
        }
    }
})();
</script>

    <body>
        <div class="page-content">
            <div class="search">
    <form role="search" method="get" action="/search/">
         <input name="searchString" class="searchInput" placeholder=" 검색하세요" type="text">
         <input type="submit" class="searchButton" value="Search">
    </form>
</div>
            <div class="post">
                <div class="post">
    <header class="post-header">
        <h1 class="page-title">
            <a href="/blog/2017/03/12/telegram-bot/"> 텔레그램 봇 스켈레톤 만들기 </a>
        </h1>
        <p class="created-date">
            2017.03.12
        </p>
        <div class="post-tag">
    node-js telegram heroku chatbot bot
</div>

        <h2>node.js, heroku로 만드는 텔레그램 챗봇</h2>
    </header>


    <div class="toc">
    </div>

    <article class="post-content">
        <ul id="markdown-toc">
  <li><a href="#준비물" id="markdown-toc-준비물">준비물</a></li>
  <li><a href="#텔레그램-api-token-얻기" id="markdown-toc-텔레그램-api-token-얻기">텔레그램 API TOKEN 얻기</a></li>
  <li><a href="#코딩" id="markdown-toc-코딩">코딩</a></li>
  <li><a href="#webjs는-왜-있는-거죠" id="markdown-toc-webjs는-왜-있는-거죠">web.js는 왜 있는 거죠?</a></li>
  <li><a href="#config-variable-설정" id="markdown-toc-config-variable-설정">Config Variable 설정</a></li>
  <li><a href="#배포" id="markdown-toc-배포">배포</a></li>
  <li><a href="#테스트" id="markdown-toc-테스트">테스트</a></li>
  <li><a href="#sleep-방지-처리" id="markdown-toc-sleep-방지-처리">sleep 방지 처리</a></li>
  <li><a href="#links" id="markdown-toc-links">Links</a></li>
</ul>

<p>심심해서 텔레그램 봇을 만들어 보았다.<br />
봇을 만든 과정을 요약해 남겨본다.</p>

<h2 id="준비물">준비물</h2>
<ol>
  <li>텔레그램 API TOKEN</li>
  <li><a href="https://heroku.com/">Heroku</a> 계정
    <ul>
      <li>무료로 봇을 돌리기 위해 Heroku를 선택했다.</li>
    </ul>
  </li>
  <li><a href="https://uptimerobot.com/">uptimerobot.com</a> 계정
    <ul>
      <li>Heroku 앱의 sleep 을 방지하기 위한 꼼수.</li>
    </ul>
  </li>
</ol>

<h2 id="텔레그램-api-token-얻기">텔레그램 API TOKEN 얻기</h2>
<p>텔레그램에서 <a href="https://telegram.me/botfather">@BotFather</a>를 찾아 다음 순서대로 말을 걸면 된다.</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">/start</code> : @BotFather를 활성화한다.</li>
  <li><code class="language-plaintext highlighter-rouge">/newbot</code> : 새로운 봇을 만들어달라고 요청한다.</li>
</ol>

<p>이후로는 @BotFather가 봇의 이름을 물어보니 적당한 이름을 요청하면 된다.
그러면 @BotFather가 답변으로 API TOKEN을 보내준다.</p>

<p>자세한 내용은 <a href="https://core.telegram.org/bots">공식 문서</a> 참고.</p>

<h2 id="코딩">코딩</h2>

<p><em>package.json</em></p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"telegram-bot"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.0.0"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
  </span><span class="nl">"main"</span><span class="p">:</span><span class="w"> </span><span class="s2">"index.js"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"scripts"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"test"</span><span class="p">:</span><span class="w"> </span><span class="s2">"echo </span><span class="se">\"</span><span class="s2">Error: no test specified</span><span class="se">\"</span><span class="s2"> &amp;&amp; exit 1"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"start"</span><span class="p">:</span><span class="w"> </span><span class="s2">"node index.js"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"dev_start"</span><span class="p">:</span><span class="w"> </span><span class="s2">"export $(cat .config) &amp;&amp; node index.js"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"repository"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"git"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"git+https://github.com/johngrib/telegram-bot.git"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"author"</span><span class="p">:</span><span class="w"> </span><span class="s2">"John Grib"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"license"</span><span class="p">:</span><span class="w"> </span><span class="s2">"MIT"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"bugs"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://github.com/johngrib/telegram-bot/issues"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"homepage"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://github.com/johngrib/telegram-bot#readme"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"dependencies"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"express"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^4.15.2"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"get-json"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0.0.3"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"node-telegram-bot-api"</span><span class="p">:</span><span class="w"> </span><span class="s2">"^0.27.0"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><em>index.js</em></p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./bot</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./web</span><span class="dl">'</span><span class="p">);</span>
</code></pre></div></div>

<p><em>bot.js</em> : bot의 비즈니스 로직이 들어갈 곳이다.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">TelegramBot</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">node-telegram-bot-api</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">getToken</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="kd">const</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">TELEGRAM_TOKEN</span><span class="p">;</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">token</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">})();</span>

<span class="kd">const</span> <span class="nx">bot</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TelegramBot</span><span class="p">(</span><span class="nx">getToken</span><span class="p">(),</span> <span class="p">{</span><span class="na">polling</span><span class="p">:</span> <span class="kc">true</span><span class="p">});</span>

<span class="nx">bot</span><span class="p">.</span><span class="nx">onText</span><span class="p">(</span><span class="sr">/</span><span class="se">\/</span><span class="sr">echo </span><span class="se">(</span><span class="sr">.+</span><span class="se">)</span><span class="sr">/</span><span class="p">,</span> <span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">match</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>

    <span class="kd">const</span> <span class="nx">chatId</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">chat</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">resp</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

    <span class="nx">bot</span><span class="p">.</span><span class="nx">sendMessage</span><span class="p">(</span><span class="nx">chatId</span><span class="p">,</span> <span class="nx">resp</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p><em>web.js</em> : http end-point를 만들어 준다.</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">packageInfo</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./package.json</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>

<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span> <span class="na">version</span><span class="p">:</span> <span class="nx">packageInfo</span><span class="p">.</span><span class="nx">version</span> <span class="p">});</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span><span class="p">,</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">host</span> <span class="o">=</span> <span class="nx">server</span><span class="p">.</span><span class="nx">address</span><span class="p">().</span><span class="nx">address</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">port</span> <span class="o">=</span> <span class="nx">server</span><span class="p">.</span><span class="nx">address</span><span class="p">().</span><span class="nx">port</span><span class="p">;</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Web server started at http://%s:%s</span><span class="dl">'</span><span class="p">,</span> <span class="nx">host</span><span class="p">,</span> <span class="nx">port</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<h2 id="webjs는-왜-있는-거죠">web.js는 왜 있는 거죠?</h2>

<p>사실 bot.js만 있어도 봇은 돌아간다. 즉 web.js는 일종의 군더더기 코드라 할 수 있다.<br />
이게 필요한 이유는 이 코드를 Heroku에서 구동하기로 결정했기 때문이다.</p>

<p>Heroku는 일정 시간 동안 deploy한 앱에 접속 요청이 없을 경우, 앱을 sleep 시켜버린다.
물론 sleep 이 된다고 해서 영원한 잠에 빠지거나 하는 건 아니고, 다음 요청이 있을 때까지 죽여 놓는 것이다.
새로운 요청을 받으면 앱을 새로 구동한 다음 웹 페이지를 보여준다.
평범한 블로그나 웹 사이트라면 sleep 상태라고 해도 10~30초 정도만 기다리면 되는 것이다.</p>

<p>하지만 실험을 해보니 봇은 웹이 아니어서 그런지 한 번 sleep 상태로 빠져들면 다시는 깨어나지 않았다.</p>

<p>그래서 나온 꼼수가 http end point를 만든 다음, 주기적으로 ping을 보내주는 서비스에 봇의 http end point를 등록해서 봇이 잠들지 않도록 해주는 것이다. 이런 서비스들 중 하나가 바로 <a href="https://uptimerobot.com/">uptimerobot.com</a>. 무료로 가입할 수 있고, 사용법도 단순하다.</p>

<p>위의 코드를 Heroku에 배포한 다음, uptimerobot에 uri를 등록해 두면 봇 스켈레톤이 완성되는 셈이다.</p>

<h2 id="config-variable-설정">Config Variable 설정</h2>

<p>배포하기 전에 Heroku Dashboard 에서 Config Variable에 <code class="language-plaintext highlighter-rouge">TELEGRAM_TOKEN</code>을 등록해 준다.<br />
이렇게 등록한 값은 node.js 코드에서 <code class="language-plaintext highlighter-rouge">process.env.TELEGRAM_TOKEN</code> 으로 접근할 수 있다.</p>

<h2 id="배포">배포</h2>

<p>Heroku는 배포가 쉬워서 좋다.</p>
<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>git push heroku master
</code></pre></div></div>

<h2 id="테스트">테스트</h2>

<p>봇이 잘 돌아가는지 텔레그램으로 확인해 본다. 위의 코드대로라면 <code class="language-plaintext highlighter-rouge">/echo test</code> 등으로 확인 가능하다.</p>

<h2 id="sleep-방지-처리">sleep 방지 처리</h2>

<p><a href="https://uptimerobot.com/">uptimerobot.com</a>에 봇의 도메인 주소를 등록해 준다.</p>

<h2 id="links">Links</h2>
<ul>
  <li><a href="https://github.com/johngrib/telegram-bot">https://github.com/johngrib/telegram-bot</a></li>
  <li><a href="https://mvalipour.github.io/node.js/2015/11/10/build-telegram-bot-nodejs-heroku">https://mvalipour.github.io/node.js/2015/11/10/build-telegram-bot-nodejs-heroku</a></li>
</ul>

    </article>
    <script>
    ;(function() {
        var tags = document.querySelectorAll('.post-tag');
        if(tags == null || tags.length < 1) {
            return;
        }

        for (var i = 0; i < tags.length; i++) {
            var item = tags[i];
            var tagList = item.innerHTML.trim();

            if(/^\s*$/.test(tagList)) {
                continue;
            }
            tagList = tagList.split(/\s+/)
                .map(function(tag) {
                    return `<a href="/tag/#${tag}">#${tag}</a>`;
                })
                .join(' ');
            console.log(tagList);
            tags[i].innerHTML = tagList;
        }
        return;
    })();
    ;(function() {
        var post = document.querySelector('article.post-content');

        if(post == null) {
            return;
        }

        (function iterate_node(node) {

            if (/^(?:p|ul|h\d|table)$/i.test(node.tagName)) {

                node.innerHTML = link(node.innerHTML);

            } else { // Node.ELEMENT_NODE
                for (var i = 0; i < node.childNodes.length; i++) {
                    iterate_node(node.childNodes[i]);
                }
            }
        })(post);

        function link(content) {
            // (1) "\[[escape]]" 와 같이 앞에 "\"가 있다면 "\[\[escape\]\]" 로 바꾸기만 하고 링크는 생성하지 않는다.
            content = content.replace(/\\\[\[(.+?)\]\]/g, '\\[\\[$1\\]\\]');
            // (2) 다음과 같은 문자열을 <a href="/wiki/document">document-name</a> 으로 replace하여 링크를 만든다.
            //  [[document]]{document-name}       => <a href="/wiki/document">document-name</a>
            //  [[/document]]{document-name}      => <a href="/wiki/document">document-name</a>
            //  [[/dir/document]]{document-name}  => <a href="/wiki/dir/document">document-name</a>
            content = content.replace(/\[\[\/?([^\[\]]+?)\]\]\{([^\{\}]+?)\}/g, '<a href="/wiki/$1">$2</a>');
            // (3) "[[document]]"가 있다면 <a href="/wiki/document">document</a> 와 같이 replace하여 링크를 만든다.
            //  예제는 (2)와 거의 비슷하다.
            content = content.replace(/\[\[\/?(.+?)\]\]/g, '<a href="/wiki/$1">$1</a>');
            // (4) (1)에서 이스케이프한 문자열을 본래 표현하려 한 형식으로 되돌린다.
            content = content.replace(/\\\[\\\[(.+?)\\\]\\\]/g, '[[$1]]');
            return content;
        }

    })();
</script>

    
    <div class="post-comments">
    
    
        <script src="https://utteranc.es/client.js"
            repo="hy43/hy43.github.io"
            issue-term="url"
            label="Comment"
            branch="master"
        async>
        </script>
    
    </div>


    <script async src="/js/toc-highlight.js"></script>
</div>

            </div>
        </div>
        <footer class="footer">
    <div>

    </div>

    <script data-ad-client="ca-pub-3675948545737694" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

</footer>
    </body>
</html>
